USE [forum]
GO

/****** Object:  View [dbo].[vi_Restrictions_Index_by_CtryRegion&Yr]    Script Date: 3/23/17 2:54:52 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
ALTER  VIEW
               [dbo].[vi_Restrictions_Index_by_CtryRegion&Yr]
AS
/***************************************************************************************************************************************************************/
SELECT
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
          [RIYv_row]          =  ROW_NUMBER()
                                 OVER(ORDER BY
                                                [Year]
                                              , [level]              DESC
                                              , VR.[Nation_fk]
                                              , [Index_abbreviation]       )
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
       , [Year]
       , [level]
       , [SubRegion6_code]    = [Region6_code]
       , [Region]             = [Region6]
       , VR.[Nation_fk]
       , VR.[Ctry_EditorialName]
       , [Index_abbreviation]
       , [Index_name]
       , [Index_value]        = [I_Rounded_value]
       , [Index_level]
       , [Index_Year]
       , [ByRegion]           = [ByRegion6]
       , [ByWorld]
       , [ByWorld&Region]
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
FROM
/*** country values and calculated median region & world values (from vr working tables)   *********************************************************************/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
       (  SELECT 
                 *
            FROM [forum_ResAnal].[dbo].[vr___05_cDB_Index_byCtryReg&Yr]
WHERE  [Index_abbreviation] IN ('GRI' , 'SHI')
  AND  [level]              !=  2.5
                                                                          )                        VR



-----------------------------------------------------------------------------------------------------------------------------------------------------------------

inner join


       (  SELECT DISTINCT
                 [Index_level]        = [Level]
                ,[Scaled_Level_value]
            FROM [forum].[dbo].[Pew_Index_Cut_Points] )                                  CP
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
on  
       [I_Scaled_value]
     = [Scaled_Level_value]


/********************************************************************* country values and calculated median region & world values (from vr working tables)   ***/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
INNER JOIN
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
    (   SELECT *
        FROM
              [forum].[dbo].[vi_Restrictions_Ctry&Q&Yr_Displayable]
        WHERE Question_abbreviation_std     IN ('GRI', 'SHI') /*     for this view */   )         AS   DQ
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  ON   VR.[Year]
     = DQ.Question_Year
 AND   VR.Nation_fk
     = DQ.Nation_fk
 AND   VR.Index_abbreviation
     = DQ.Question_abbreviation_std
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
/***************************************************************************************************************************************************************/

GO


