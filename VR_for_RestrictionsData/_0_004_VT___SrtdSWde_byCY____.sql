/***************************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 0.004    ---------------------------------------------------------------------------------------- '
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***     >>>>>         This script creates sorted semi-WIDE set of (working and/or final) data from the 'Global Restriction on Religion Study'     <<<<<     ***/
/***                                                                                                                                                         ***/
/***                    -  Variables have a more useful sorting order in the table                                                                           ***/
/***                    -  Data includes UN Popu;ation Data                                                                                                  ***/
/***                    -  Data includes CALCULATED/AGGREGATED variables (from the basic variables used ad source)                                           ***/
/***                    -  Data of each row are by country-year (semi-wide)                                                                                  ***/
/***                    -  As any wide/semi-wide set of data, these views and lookup tables only include numeric values for GR&SH R                          ***/
/***                    -  ==> DEFAULT:   FD  initial section to run sql script using final data        (it will create view & lookup table)                 ***/
/***                    -  ==>    COMMENT FD  initial section                                                                                                ***/
/***                           & UNCOMENT  W  initial section to run sql script using working data      (it will create view & lookup table)                 ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***                                               |                 W                 |                F D                |                                 ***/
/***                                               |        working environment        |            final  data            |                                 ***/
/***                     --------------------------+-----------------------------------+-----------------------------------+                                 ***/
/***                                    database:  |            [GRSHRcode]            |          [forum_ResAnal]          |                                 ***/
/***                     --------------------------+-----------------------------------+-----------------------------------+                                 ***/
/***                               1st step view:  |  [vr___04w]                       |  [vr___04_]                       |                                 ***/
/***                     --------------------------+-----------------------------------+-----------------------------------+                                 ***/
/***                       2ns step lookup table:  |  [vr___04_wDB_SemiWide_byCtry&Yr] |  [vr___04_cDB_SemiWide_byCtry&Yr] |                                 ***/
/***                     --------------------------+-----------------------------------+-----------------------------------+                                 ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/*******                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
--	/***                                                  ***/                                                                                              /***/
--	/***   ********************   ****************        ***/                                                                                              /***/
--	/***   ********************   *****************       ***/                                                                                              /***/
	/***   ***                    ***            ***      ***/     USE [forum_ResAnal]                                                                      /***/
	/***   ***                    ***             ***     ***/     SET ANSI_NULLS ON                                                                        /***/
	/***   ***                    ***              ***    ***/     SET QUOTED_IDENTIFIER ON                                                                 /***/
	/***   ****************       ***              ***    ***/                                                                                              /***/
	/***   ****************       ***              ***    ***/     declare     @CUDBNAME           nvarchar(max) = N'forum_ResAnal'                         /***/
	/***   ***                    ***              ***    ***/     declare     @VIEWNAME           nvarchar(max) = N'vr___04_'                              /***/
	/***   ***                    ***              ***    ***/     declare     @TABLNAME           nvarchar(max) = N'vr___04_cDB_SemiWide_byCtry&Yr'        /***/
	/***   ***                    ***              ***    ***/     declare     @SOURCE01           nvarchar(max) = N'vr___03_'                              /***/
	/***   ***                    ***             ***     ***/     declare     @TEMPTAB1 TABLE ( V nvarchar(max) )                                          /***/
	/***   ***                    ***            ***      ***/     INSERT INTO @TEMPTAB1 SELECT [V]= [COLUMN_NAME] FROM [INFORMATION_SCHEMA].[COLUMNS]      /***/
	/***   ***                    *****************       ***/                            WHERE      [TABLE_NAME]  = 'vr___03_'                             /***/
--	/***   ***                    ****************        ***/                                                                                              /***/
--	/***                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/*******                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
--	/***                                                  ***/                                                                                              /***/
--	/***   *****                                 *****    ***/                                                                                              /***/
--	/***   *****                                 *****    ***/                                                                                              /***/
--	/***     ***                                 ***      ***/     USE [GRSHRcode]                                                                          /***/
--	/***      ***                               ***       ***/     SET ANSI_NULLS ON                                                                        /***/
--	/***       ***                             ***        ***/     SET QUOTED_IDENTIFIER ON                                                                 /***/
--	/***        ***                           ***         ***/                                                                                              /***/
--	/***         ***           ***           ***          ***/     declare     @CUDBNAME           nvarchar(max) = N'GRSHRcode'                             /***/
--	/***          ***         *****         ***           ***/     declare     @VIEWNAME           nvarchar(max) = N'vr___04w'                              /***/
--	/***           ***       *** ***       ***            ***/     declare     @TABLNAME           nvarchar(max) = N'vr___04_wDB_SemiWide_byCtry&Yr'        /***/
--	/***            ***     ***   ***     ***             ***/     declare     @SOURCE01           nvarchar(max) = N'vr___03w'                              /***/
--	/***             ***   ***     ***   ***              ***/     declare     @TEMPTAB1 TABLE ( V nvarchar(max) )                                          /***/
--	/***              *** ***       *** ***               ***/     INSERT INTO @TEMPTAB1 SELECT [V]= [COLUMN_NAME] FROM [INFORMATION_SCHEMA].[COLUMNS]      /***/
--	/***              *******       *******               ***/                            WHERE      [TABLE_NAME]  = 'vr___03w'                             /***/
--	/***               *****         *****                ***/                                                                                              /***/
--	/***                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/************************************************************/     declare     @ALLCODE            nvarchar(max)                                            /***/
/************************************************************/     declare     @ENDCODET           nvarchar(max)                                            /***/
/************************************************************/     declare     @CODELABELS         nvarchar(max)                                            /***/
/************************************************************/     declare     @VIEWLABEL          nvarchar(max) = N'vr___04l'                              /***/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
set     @ALLCODE = 
/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N' ALTER  VIEW .[dbo].'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/* name of view to be updated   -------------------------------------------------------------------------------------------------------------------------------*/                    
     quotename(@VIEWNAME)
/*--------------------------------------------------------------------------------------------------------------------------------- name of view to be updated */
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
  AS
 '
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*** main select statement starts ******************************************************************************************************************************/
N'
  SELECT * FROM
   (
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
   SELECT
           [byCY_row]           =  ROW_NUMBER()
                                   OVER(ORDER BY
                                                   [Nation_fk]
                                                 , [Question_Year] )
      ,    [Nation_fk]
      ,    [Ctry_EditorialName]
      ,    [UN_TotalPopulation]
      ,    [Region5]
      ,    [Region6]
      ,    [Question_Year]
      ,    [GRI]
      ,    [GRI_rd_1d]
      ,    [GRI_scaled]
      ,    [SHI]
      ,    [SHI_rd_1d]
      ,    [SHI_scaled]
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
(                                                                                /*** parenthesis to include query for the cell to be used as part of code   ***/
/***************************************************************************************************************************************************************/
/*** Begin selection (into text, in a cell) of a comma delimited list of fields from a system view *************************************************************/
/***************************************************************************************************************************************************************/
    SELECT    ',' + [V]                                                         /*** SELECT comma delimiter concatenated to [FieldName] in unsorted view     ***/
      FROM               @TEMPTAB1                                              /*** from temp table including all field names as rows                       ***/
     WHERE                                                                      /*** FILTER:                                                                 ***/
                    [V] NOT IN (  'Nation_fk'                                   /***         to exclude fileds initialy listed                               ***/
                                 ,'Region5'                                     /***                                                            ...          ***/
                                 ,'Region6'                                     /***                                                            ...          ***/
                                 ,'Ctry_EditorialName'                          /***                                                            ...          ***/
                                 ,'Question_Year'                               /***                                                            ...          ***/
                                 ,'GRI'                                         /***                                                            ...          ***/
                                 ,'GRI_rd_1d'                                   /***                                                            ...          ***/
                                 ,'GRI_scaled'                                  /***                                                            ...          ***/
                                 ,'SHI'                                         /***                                                            ...          ***/
                                 ,'SHI_rd_1d'                                   /***                                                            ...          ***/
                                 ,'SHI_scaled'            )                     /***                                                            ...          ***/
           AND      [V] NOT LIKE  '%ny[1-3]'                                    /***         also exclude redundant "ny" fileds                              ***/
           AND      [V] NOT LIKE  '%ny[a-f]'                                    /***         also exclude redundant "ny" fileds                              ***/
  ORDER BY          [V]                                                         /*** sorting using field in temp table                                       ***/
                                                            FOR XML PATH('')    /*** Modifies the selected rowset nesting all cells into an XML string cell  ***/
/***************************************************************************************************************************************************************/
/*** End of the selection (into text, in a cell) of a comma delimited list of fields ***************************************************************************/
/***************************************************************************************************************************************************************/
)                                                                                /*** parenthesis to include query for the cell to be used as part of code   ***/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
  FROM 
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/* name of entity (view) used as data source ------------------------------------------------------------------------------------------------------------------*/
     quotename(@CUDBNAME) + '..' + quotename(@SOURCE01)
/*------------------------------------------------------------------------------------------------------------------ name of entity (view) used as data source */
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*--- > (join) population -------------------------------------------------------------------------------------------------------------------------------------*/
N'
  JOIN 
       (  SELECT 
                  [FYr]                 = [Field_year]
                , [Nfk]                 = [Nation_fk]
                , [UN_TotalPopulation]  =  CAST([Cnt] AS BIGINT)
             FROM [forum].[dbo].[Pew_Nation_Age_Sex_Value]
                , [forum].[dbo].[Pew_Field]
           WHERE  [Sex_fk]       = 0
             AND  [Age_fk]       = 0
             AND  [Scenario_id]  = 3
             AND  [Field_fk]
                = [Field_pk]                                ) POP
'
/*------------------------------------------------------------------------------------------------------------------------------------- (join) population < ---*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
    ON            [FYr]                 = CAST([Question_Year] AS nvarchar(4))
   AND            [Nfk]                 = [Nation_fk]
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
 ) SELECTED
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
/*** checking / executing SQL statement that has been stored as a string variable ******************************************************************************/
--	EXEC dbo.LongPrint @ALLCODE                                     /***        display the currently stored code (to be executed)                           ***/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	EXEC sp_executesql @ALLCODE                                     /***        execute the code that has been stored as text                                ***/
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
set     @ENDCODET =
/***************************************************************************************************************************************************************/
N'
  IF OBJECT_ID  (N''' + quotename(@CUDBNAME) + N'.[dbo].' + quotename(@TABLNAME) + N''', N''U'') IS NOT NULL
    DROP TABLE      ' + quotename(@CUDBNAME) + N'.[dbo].' + quotename(@TABLNAME) + N'
 SELECT * INTO      ' + quotename(@CUDBNAME) + N'.[dbo].' + quotename(@TABLNAME) + N'
          FROM      ' + quotename(@CUDBNAME) + N'.[dbo].' + quotename(@VIEWNAME) + N'
'
/***************************************************************************************************************************************************************/
--	EXEC dbo.LongPrint @ENDCODET                                    /***        display the currently stored code (to be executed)                           ***/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	EXEC              (@ENDCODET)                                   /***        execute the code that has been stored as text                                ***/
/***************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************/
--	SELECT * FROM [vr___04_cDB_SemiWide_byCtry&Yr]
--	SELECT * FROM [vr___04_wDB_SemiWide_byCtry&Yr]
/***************************************************************************************************************************************************************/



/***************************************************************************************************************************************************************/
set     @CODELABELS = 
/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N' ALTER  VIEW .[dbo].'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/* name of view to be updated   -------------------------------------------------------------------------------------------------------------------------------*/                    
     quotename(@VIEWLABEL)
/*--------------------------------------------------------------------------------------------------------------------------------- name of view to be updated */
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
  AS
 '
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*** main select statement starts ******************************************************************************************************************************/
N'
  SELECT * FROM
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/* main query (between parenthesis) ---------------------------------------------------------------------------------------------------------------------------*/
N'
   (
     SELECT
                  [k]         =  ROW_NUMBER() OVER(ORDER BY [COLUMN_NAME])
                , [VarName]   =  SUBSTRING(              (S.[COLUMN_NAME]
                               + ''                         '' ),1, 25)
                , [VarLabel]  =  '' "'' + L.[attr] + ''" ''
       FROM       [INFORMATION_SCHEMA].[COLUMNS]                            S
 INNER JOIN       [forum]..[Pew_Question_Std]                               Q
         ON     S.[COLUMN_NAME]
              = Q.[Question_abbreviation_std]
 INNER JOIN       [forum]..[Pew_Question_Attributes]                        L
		 ON     Q.[Question_Std_pk]
              = L.[Question_Std_fk]
    WHERE       S.[TABLE_NAME]
              = '''
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/* name of updated view, used to filter rows from System View -------------------------------------------------------------------------------------------------*/                    
                   @VIEWNAME
/*-----------------------------------------------------------------------------------------------  name of updated view, used to filter rows from System View  */
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'''
      AND       L.[attk]
              = ''80CharsLabel''                                                                      )  SETA '
/*--------------------------------------------------------------------------------------------------------------------------- main query (between parenthesis) */
/******************************************************************************************************************************** main select statement ends ***/
/***************************************************************************************************************************************************************/
/*** checking / executing SQL statement that has been stored as a string variable ******************************************************************************/
--	EXEC dbo.LongPrint @CODELABELS                                  /***        display the currently stored code (to be executed)                           ***/
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
  	EXEC sp_executesql @CODELABELS                                   /***        execute the code that has been stored as text                                ***/
/***************************************************************************************************************************************************************/
GO