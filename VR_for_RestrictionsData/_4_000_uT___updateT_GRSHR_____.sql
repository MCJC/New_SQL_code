/***************************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 4.000    ---------------------------------------------------------------------------------------- '
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***     >>>>>         This script loads working coded data from the 'Global Restriction on Religion Study' into the database [forum]              <<<<<     ***/
/***                                                                                                                                                         ***/
/***                    -  Source for loading data is a lookup table because views are dinamically updated                                                   ***/
/***                    -  Data includes numeric values and descriptive wordings for GR&SH R                                                                 ***/
/***                    -  Both coded data and target tables are backed up                                                                                   ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***                             |             W             |              F  D              |                   BkUp D                |                    ***/
/***                             |    working environment    |          final  data           |              backed up data             |                    ***/
/***            -----------------+---------------------------+--------------------------------+-----------------------------------------+                    ***/
/***                  database:  |        [GRSHRcode]        |        [forum_ResAnal]         |                [_bk_forum]              |                    ***/
/***            -----------------+---------------------------+--------------------------------+-----------------------------------------+                    ***/
/***              source table:  |  [T07_CodedNoAggregated]  |                                |  [CodedNoAggregated_BackUp]             |                    ***/
/***            -----------------+---------------------------+--------------------------------+-----------------------------------------+                    ***/
/***             target tables:  |                           |  [Pew_Answer_NoStd]            |            [Pew_Answer_NoStd_YYYYMMDD]  |                    ***/
/***                             |                           |  [Pew_Nation_Answer]           |           [Pew_Nation_Answer_YYYYMMDD]  |                    ***/
/***                             |                           |  [Pew_Locality_Answer]         |         [Pew_Locality_Answer_YYYYMMDD]  |                    ***/
/***                             |                           |  [Pew_Nation_Religion_Answer]  |  [Pew_Nation_Religion_Answer_YYYYMMDD]  |                    ***/
/***            -----------------+---------------------------+--------------------------------+-----------------------------------------+                    ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***         2. Backup data to be added to target tables                                                                                                     ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--	  DECLARE @CmpDt            VARCHAR(20)
--	  SET     @CmpDt = (CONVERT(VARCHAR(20),GETDATE(),113))
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--	EXEC ( '  INSERT INTO   [_bk_forum].[dbo].[CodedNoAggregated_BackUp]
--	               SELECT   [CNAbk_row]
--	                     =  ROW_NUMBER()
--	                        OVER(ORDER BY [CNA_row])
--	                      ,	[BkUp_date]  = ''' + @CmpDt + '''
--	                      , * 	
--	                 FROM   [GRSHRcode].[dbo].[T07_CodedNoAggregated]    ' )
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***         2. Backup current target tables                                                                                                                 ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--	  DECLARE  @CrDt    varchar( 8)
--	  DECLARE  @TofI    varchar(50)
--	  SET      @CrDt = (CONVERT(VARCHAR(8),GETDATE(),112))
--	  DECLARE  MyCursor
--	  CURSOR FOR      SELECT 'Pew_Answer_NoStd'
--	            UNION SELECT 'Pew_Locality_Answer'
--	            UNION SELECT 'Pew_Nation_Answer'
--	            UNION SELECT 'Pew_Nation_Religion_Answer'
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--	   OPEN    MyCursor
--		FETCH  NEXT
--		FROM   MyCursor
--		INTO   @TofI
--		WHILE  @@FETCH_STATUS = 0
--		BEGIN
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--	           EXEC ( ' SELECT *
--	                    INTO   [_bk_forum].[dbo].[' + @TofI + '_' + @CrDt + ']
--	                    FROM       [forum].[dbo].[' + @TofI + ']' )
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
--		FETCH  NEXT
--		FROM   MyCursor
--		INTO   @TofI
--	    END
--	    CLOSE  MyCursor
--	DEALLOCATE MyCursor
--	/*---------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/


/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***         3. Load coded data into the database                                                                                                            ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
/***         3.1         [Pew_Answer_NoStd]                                                                                                                  ***/
/***************************************************************************************************************************************************************/
--	INSERT INTO [forum]..[Pew_Answer_NoStd]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
  SELECT
           DISTINCT
           [Answer_pk]                              = [ar_Answer_pk]
         , [Answer_value_NoStd]                     = [ar_Answer_value_NoStd]
         , [Answer_Wording]                         = [ar_Answer_Wording]
         , [Answer_Std_fk]                          = [ar_Answer_Std_fk]
         , [Question_fk]                            = [ar_Question_fk]
    FROM   [GRSHRcode].[dbo].[T07_CodedNoAggregated]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
/***         3.2         [Pew_Nation_Answer]                                                                                                                 ***/
/***************************************************************************************************************************************************************/
--	INSERT INTO [forum]..[Pew_Nation_Answer]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
  SELECT
           DISTINCT
           [Nation_answer_pk]                       = [na_Nation_answer_pk]
         , [Nation_fk]                              = [na_Nation_fk]
         , [Answer_fk]                              = [na_Answer_fk]
         , [display]                                = [na_display]
    FROM   [GRSHRcode].[dbo].[T07_CodedNoAggregated]
   WHERE                                              [na_Nation_answer_pk]             IS NOT NULL
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
/***         3.3         [Pew_Locality_Answer]                                                                                                               ***/
/***************************************************************************************************************************************************************/
--	INSERT INTO [forum]..[Pew_Locality_Answer]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
  SELECT
           DISTINCT
           [Locality_answer_pk]                     = [la_Locality_answer_pk]
         , [Locality_fk]                            = [la_Locality_fk]
         , [Answer_fk]                              = [la_Answer_fk]
         , [display]                                = [la_display]
    FROM   [GRSHRcode].[dbo].[T07_CodedNoAggregated]
   WHERE                                              [la_Locality_answer_pk]           IS NOT NULL
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
/***         3.4         [Pew_Nation_Religion_Answer]                                                                                                        ***/
/***************************************************************************************************************************************************************/
--	INSERT INTO [forum]..[Pew_Nation_Religion_Answer]
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
  SELECT
           DISTINCT
           [Nation_religion_answer_pk]              = [ra_Nation_religion_answer_pk]
         , [Nation_fk]                              = [ra_Nation_fk]
         , [Religion_group_fk]                      = [ra_Religion_group_fk]
         , [Answer_fk]                              = [ra_Answer_fk]
         , [display]                                = [ra_display]
    FROM   [GRSHRcode].[dbo].[T07_CodedNoAggregated]
   WHERE                                              [ra_Nation_religion_answer_pk]    IS NOT NULL
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/




/***************************************************************************************************************************************************************/
--  5,407:  A
--   		C   25,955
--   		L    3,762
--   		R    8,910
--              38,627    rows
/***************************************************************************************************************************************************************/
