/***************************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 006    ------------------------------------------------------------------------------------------ '
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***     >>>>>   This is the script used to create the lookup table [forum_ResAnal].[dbo].[vr_05w_SemiWide_by_Ctry&Year]                           <<<<<     ***/
/***             This table only includes numeric values aggregated by country/religion & year (does not include descriptive wordings).                      ***/
/***                                                                                                                                                         ***/
/***                                                      > > >     lookup tables work faster     < < <                                                      ***/
/***                                                                                                                                                         ***/



/***************************************************************************************************************************************************************/
Print 
'--- ' + CONVERT (VARCHAR(19), SYSDATETIME()) + ' ==>  script 0.004    ---------------------------------------------------------------------------------------- '
/***************************************************************************************************************************************************************/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***     >>>>>         This script creates semi-WIDE set of (working and/or final) data from the 'Global Restriction on Religion Study'            <<<<<     ***/
/***                                                                                                                                                         ***/
/***                    -  Data includes CALCULATED/AGGREGATED variables (from the basic variables used ad source)                                           ***/
/***                    -  Data of each row are by country-year (semi-wide)                                                                                  ***/
/***                    -  As any wide/semi-wide set of data, these views and lookup tables only include numeric values for GR&SH R                          ***/
/***                    -  ==> UNCOMENT  W  or  FD  initial section to run sql script (it will create view & lookup table)                                   ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***                                               |                 W                 |                F D                |                                 ***/
/***                                               |        working environment        |            final  data            |                                 ***/
/***                     --------------------------+-----------------------------------+-----------------------------------+                                 ***/
/***                                    database:  |            [GRSHRcode]            |          [forum_ResAnal]          |                                 ***/
/***                     --------------------------+-----------------------------------+-----------------------------------+                                 ***/
/***                               1st step view:  |  [vr___03_wDB_W&Xtra_byCtry&Year] |  [vr___03_]                       |                                 ***/
/***                     --------------------------+-----------------------------------+-----------------------------------+                                 ***/
/***                       2ns step lookup table:  |  [vr___03_wDBtW&Xtra_byCtry&Year] |  [vr___03_cDB_W&Xtra_byCtry&Year] |                                 ***/
/***                     --------------------------+-----------------------------------+-----------------------------------+                                 ***/
/***                                                                                                                                                         ***/
/***                                                                                                                                                         ***/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/*******                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
--	/***                                                  ***/                                                                                              /***/
--	/***   *****                                 *****    ***/                                                                                              /***/
--	/***   *****                                 *****    ***/                                                                                              /***/
--	/***     ***                                 ***      ***/                                                                                              /***/
--	/***      ***                               ***       ***/     USE [GRSHRcode]                                                                          /***/
--	/***       ***                             ***        ***/     SET ANSI_NULLS ON                                                                        /***/
--	/***        ***                           ***         ***/     SET QUOTED_IDENTIFIER ON                                                                 /***/
--	/***         ***           ***           ***          ***/                                                                                              /***/
--	/***          ***         *****         ***           ***/     declare     @CUDBNAME           nvarchar(max) = N'GRSHRcode'                             /***/
--	/***           ***       *** ***       ***            ***/     declare     @VIEWNAME           nvarchar(max) = N'vr___03_wDB_W&Xtra_byCtry&Year'        /***/
--	/***            ***     ***   ***     ***             ***/     declare     @TABLNAME           nvarchar(max) = N'vr___03_wDBtW&Xtra_byCtry&Year'        /***/
--	/***             ***   ***     ***   ***              ***/     declare     @SOURCE01           nvarchar(max) = N'vr___02_wDB_Wide__by_Ctry&Year'        /***/
--	/***              *** ***       *** ***               ***/                                                                                              /***/
--	/***              *******       *******               ***/                                                                                              /***/
--	/***               *****         *****                ***/                                                                                              /***/
--	/***                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/*******                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
--	/***                                                  ***/                                                                                              /***/
--	/***   ********************   ****************        ***/                                                                                              /***/
--	/***   ********************   *****************       ***/                                                                                              /***/
--	/***   ***                    ***            ***      ***/                                                                                              /***/
--	/***   ***                    ***             ***     ***/     USE [forum_ResAnal]                                                                      /***/
--	/***   ***                    ***              ***    ***/     SET ANSI_NULLS ON                                                                        /***/
--	/***   ****************       ***              ***    ***/     SET QUOTED_IDENTIFIER ON                                                                 /***/
--	/***   ****************       ***              ***    ***/                                                                                              /***/
--	/***   ***                    ***              ***    ***/     declare     @CUDBNAME           nvarchar(max) = N'forum_ResAnal'                         /***/
--	/***   ***                    ***              ***    ***/     declare     @VIEWNAME           nvarchar(max) = N'vr___03_'                              /***/
--	/***   ***                    ***              ***    ***/     declare     @TABLNAME           nvarchar(max) = N'vr___03_cDB_W&Xtra_byCtry&Year'        /***/
--	/***   ***                    ***             ***     ***/     declare     @SOURCE01           nvarchar(max) = N'vr___02_'                              /***/
--	/***   ***                    ***            ***      ***/                                                                                              /***/
--	/***   ***                    *****************       ***/                                                                                              /***/
--	/***   ***                    ****************        ***/                                                                                              /***/
--	/***                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
/*******                                                  ***/                                                                                              /***/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/************************************************************/     declare     @ALLCODE            nvarchar(max)                                            /***/
/************************************************************/     declare     @SBEGCODE           nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_0           nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_01        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_02        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_03        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_04        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_05        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_06        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_07        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_08        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_09        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_10        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_11        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_1_12        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_2           nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_2_00        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_2_01        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_2_02        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_2_03        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_2_04        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_2_05        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_3           nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_3_00        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_3_01        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_3_02        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_3_03        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_3_04        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_3_05        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_3_06        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_4           nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_4_00        nvarchar(max)                                            /***/
/************************************************************/     declare     @SBCODE_4_01        nvarchar(max)                                            /***/
/************************************************************/ --  declare     @SBCODE_4_02        nvarchar(max)                                            /***/
/************************************************************/ --  declare     @SBCODE_5           nvarchar(max)                                            /***/
/************************************************************/ --  declare     @SBCODE_5_00        nvarchar(max)                                            /***/
/************************************************************/ --  declare     @SBCODE_5_01        nvarchar(max)                                            /***/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
/***************************************************************************************************************************************************************/
--*** NOTE -> May need to:
--                          Clean XSG_25n27  as rowmax(GRX_25_01_2010 SHX_27_01_2010)
/***************************************************************************************************************************************************************/



/***************************************************************************************************************************************************************/
USE [GRSHRcode]
GO
/***************************************************************************************************************************************************************/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/***************************************************************************************************************************************************************/
declare @ALLCODE nvarchar(max)
/***************************************************************************************************************************************************************/
set     @ALLCODE = 
/***************************************************************************************************************************************************************/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
ALTER  VIEW                      [dbo].[vr___04_wDB_SemiWide_byCtry&Yr]        AS
SELECT * FROM
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
 ( SELECT
           [byCY_row]           =  ROW_NUMBER()
                                   OVER(ORDER BY
                                                   [Nation_fk]
                                                 , [Question_Year] )
      ,    [Nation_fk]
      ,    [Ctry_EditorialName]
      ,    [UN_TotalPopulation]
      ,    [Region5]
      ,    [Region6]
      ,    [Question_Year]
      ,    [GRI]
      ,    [GRI_rd_1d]
      ,    [GRI_scaled]
      ,    [GRI_change] 
      ,    [GRI_change_extent] 
      ,    [SHI]
      ,    [SHI_rd_1d]
      ,    [SHI_scaled]
      ,    [SHI_change] 
      ,    [SHI_change_extent]
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*** Begin selection (into text, in a cell) of a comma delimited list of fields from a system view *************************************************************/
/***************************************************************************************************************************************************************/
(                                                                               /*** parenthesis to include query for the cell to be stuffed                ***/
    SELECT                                                                      /*** SELECT statement                                                        ***/
          ', '                                                                  /*** comma delimiter                                                         ***/
        +                                                                       /*** concatenated to...                                                      ***/
          [COLUMN_NAME]                                                         /*** Fiels including all Q Abb Std (StdVarName)                              ***/
    FROM                                                                        /*** from...                                                                 ***/
          [INFORMATION_SCHEMA].[COLUMNS]                                        /*** name of the sys view which includes all field (var) names as rows       ***/
WHERE                                                                           /*** FILTER:                                                                 ***/
          [TABLE_NAME] = 'vr___03_wDB_W&Xtra_byCtry&Year'                       /*** only the view vr_03                                                     ***/
  AND                                                                           /*** FILTER:                                                                 ***/
          [COLUMN_NAME] NOT IN (  'Nation_fk'                                   /*** exclude fileds initialy listed                                          ***/
                                 ,'Region5'                                     /***                                                                         ***/
                                 ,'Region6'                                     /***                                                                         ***/
                                 ,'Ctry_EditorialName'                          /***                                                                         ***/
                                 ,'Question_Year'                               /***                                                                         ***/
                                 ,'GRI'                                         /***                                                                         ***/
                                 ,'GRI_rd_1d'                                   /***                                                                         ***/
                                 ,'GRI_scaled'                                  /***                                                                         ***/
                                 ,'GRI_change'                                  /***                                                                         ***/ 
                                 ,'GRI_change_extent'                           /***                                                                         ***/
                                 ,'SHI'                                         /***                                                                         ***/
                                 ,'SHI_rd_1d'                                   /***                                                                         ***/
                                 ,'SHI_scaled'                                  /***                                                                         ***/
                                 ,'SHI_change'                                  /***                                                                         ***/
                                 ,'SHI_change_extent'     )                     /***                                                                         ***/
  AND                                                                           /*** FILTER:                                                                 ***/
          [COLUMN_NAME] NOT LIKE  '%ny[1-3]'                                    /*** exclude complimentary "ny" fileds redundant                             ***/
  AND                                                                           /*** FILTER:                                                                 ***/
          [COLUMN_NAME] NOT LIKE  '%ny[a-f]'                                    /*** exclude complimentary "ny" fileds redundant                             ***/
         ORDER BY                                                               /*** sorting order usesd to order stored & extra variables alphabetically    ***/
          ', '                                                                  /*** including comma delimiter                        -> as part of sorting  ***/
        +                                                                       /*** concatenated to...                               -> as part of sorting  ***/
          [COLUMN_NAME]                                                         /*** Fiels including all Q Abb Std (StdVarName)       -> as part of sorting  ***/
         for xml path('')                                                       /*** Modifies the selected rowset nesting all cells into an XML string cell  ***/
/***************************************************************************************************************************************************************/
/*** End of the selection (into text, in a cell) of a comma delimited list of fields ***************************************************************************/
/***************************************************************************************************************************************************************/
)                                                                                /*** parenthesis to include query for the cell to be stuffed                ***/
/****************************************************************************************************************************** stuffing function ends here! ***/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*--- > main dataset ------------------------------------------------------------------------------------------------------------------------------------------*/
N'
  FROM [vr___03_wDB_W&Xtra_byCtry&Year]
'
/*--- < main dataset ------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N' JOIN '
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*--- > population --------------------------------------------------------------------------------------------------------------------------------------------*/
N'
       (  SELECT 
                  [FYr]                 = [Field_year]
                , [Nfk]                 = [Nation_fk]
                , [UN_TotalPopulation]  =  CAST([Cnt] AS BIGINT)
             FROM [forum].[dbo].[Pew_Nation_Age_Sex_Value]
                , [forum].[dbo].[Pew_Field]
           WHERE  [Sex_fk]       = 0
             AND  [Age_fk]       = 0
             AND  [Scenario_id]  = 3
             AND  [Field_fk]
                = [Field_pk]                                ) POP
'
/*--- < population --------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
    ON            [FYr]                 = [Question_Year]
   AND            [Nfk]                 = [Nation_fk]
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
+
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
N'
 ) SELECTED
'
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/***************************************************************************************************************************************************************/
/*** This is a way for checking the SQL statement that has been stored as a string variable ********************************************************************/
--	EXEC dbo.LongPrint @ALLCODE                                     /***        display the currently stored code (to be executed)                           ***/
/*** The complete SQL statement stored as a string variable is executed as a character string ******************************************************************/
	EXEC              (@ALLCODE)                                    /***        execute the code that has been stored as text                                ***/
/***************************************************************************************************************************************************************/
GO
/***************************************************************************************************************************************************************/
--	SELECT * FROM [vr___04_wDB_SemiWide_byCtry&Yr]
/***************************************************************************************************************************************************************/
